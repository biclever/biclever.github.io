<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title id="pageTitle">$TITLE</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <style>
    .container {
      max-width: 80%;
    }
    .help-section {
      margin-bottom: 20px;
    }
    textarea {
      padding: 10px;
    }
    /* The row that holds the two main buttons and optional controls */
    #buttonRow {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    /* Buttons are stacked if needed */
    .button-container {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    /* The optional controls container expands to take leftover space on the row */
    #optionalControls {
      display: flex;
      flex: 1; 
      gap: 1rem;
    }
    /* For text controls, we allow them to flex-fill. Radio groups remain compact. */
    .flex-fill-text {
      flex: 1; 
    }
    /* Minimum width for the label portion of an input-group */
    .input-group-text {
      min-width: 100px;
    }
    #helpText pre {
      margin-left: 10px;
      padding: 5px;
      background-color: #fafbff;
      border-radius: 4px;
      font-size: 0.9em;
    }
  </style>
</head>
<body onload="document.getElementById('inputText').focus()">
  <div class="container">
    <header class="mb-3 mt-5" id="header">
      <div class="logo">
        <a href="/">
          <img width="90" height="32" alt="Biclever - Tools for Business Intelligence" src="/images/logo/logo.svg">
        </a>
      </div>
      <h1 id="toolTitle">$TITLE</h1>
      <!-- The description now gets a (more) link appended -->
      <p class="text-muted" id="toolDescription">$DESCRIPTION</p>
    </header>

    <!-- Combined row for buttons + optional controls -->
    <div id="buttonRow">
      <!-- Convert button -->
      <div class="button-container">
        <button class="btn btn-primary px-4" onclick="processText()">Convert</button>
      </div>

      <!-- Copy button -->
      <div class="button-container">
        <button class="btn btn-primary px-4" onclick="copyToClipboard()">Copy</button>
      </div>

      <!-- Optional controls (created dynamically) -->
      <div id="optionalControls"></div>
    </div>

    <!-- Textareas -->
    <div class="row" id="toolContainer">
      <div class="col-md-6 mb-3">
        <textarea id="inputText" class="form-control" rows="20" placeholder="Enter text here..."></textarea>
      </div>
      <div class="col-md-6 mb-3">
        <textarea id="outputText" class="form-control" rows="20" placeholder="Output will appear here..." readonly></textarea>
      </div>
    </div>

    <!-- Help is always visible -->
    <div class="help-section" id="helpColumn">
      <div class="p-3 border rounded mt-3" id="helpText">$HELP</div>
    </div>
  </div>

  <!-- Load external tool configuration & transformation logic -->
  <script src="tool-config.js"></script>

  <!-- GUI Logic -->
  <script>
    // 1. Initialize the page with config data
    document.getElementById("pageTitle").innerText = toolConfig.title;
    document.getElementById("toolTitle").innerText = toolConfig.title;
    // Add (more) link to the description which will scroll to help
    document.getElementById("toolDescription").innerHTML =
      toolConfig.description + ' <a href="#" id="helpLink">(more)</a>';
    document.getElementById("helpText").innerHTML = toolConfig.helpText;
    
    // 2. Dynamically create optional controls
    const optionalControlsContainer = document.getElementById("optionalControls");
    if (Array.isArray(toolConfig.optionalControls) && toolConfig.optionalControls.length > 0) {
      optionalControlsContainer.style.display = "flex";

      toolConfig.optionalControls.forEach(control => {
        // Unique ID for the control
        const controlId = `control-${control.property}`;

        // Parent container for each control
        // We'll use a normal flex item for all, but only "text" gets flex-fill
        const controlItem = document.createElement("div");
        controlItem.className = "d-flex align-items-center";

        // If it's text, we also add 'flex-fill-text' so it can expand
        if (control.type === "text") {
          controlItem.classList.add("flex-fill-text");
        }

        if (control.type === "radio") {
          // Keep it compact
          const radioDiv = document.createElement("div");
          radioDiv.className = "btn-group";
          radioDiv.setAttribute("role", "group");

          // Split label by | to get options
          const options = control.label.split("|").map(o => o.trim());
          options.forEach((option, index) => {
            const radioId = controlId + "-" + index;

            const radioInput = document.createElement("input");
            radioInput.type = "radio";
            radioInput.className = "btn-check";
            radioInput.name = controlId; 
            radioInput.id = radioId;
            radioInput.value = option;
            if (index === 0) radioInput.checked = true;

            const radioLabel = document.createElement("label");
            radioLabel.className = "btn btn-outline-primary";
            radioLabel.htmlFor = radioId;
            radioLabel.innerText = option;

            radioDiv.appendChild(radioInput);
            radioDiv.appendChild(radioLabel);
          });

          controlItem.appendChild(radioDiv);
        } 
        else if (control.type === "text") {
          // This can now flex-fill
          const groupDiv = document.createElement("div");
          groupDiv.className = "input-group flex-fill"; // fill horizontal space

          const span = document.createElement("span");
          span.className = "input-group-text";
          span.innerText = control.label;

          const input = document.createElement("input");
          input.type = "text";
          input.className = "form-control";
          input.id = controlId;

          groupDiv.appendChild(span);
          groupDiv.appendChild(input);

          controlItem.appendChild(groupDiv);
        }

        // Add the control to the row
        optionalControlsContainer.appendChild(controlItem);
      });
    }

    // 3. (more) link scrolls to the help section
    document.getElementById("helpLink").addEventListener("click", function(e) {
      e.preventDefault();
      document.getElementById("helpColumn").scrollIntoView({ behavior: "smooth", block: "start" });
    });

    // 4. Handle Tab key for main textarea
    document.getElementById("inputText").addEventListener("keydown", function (event) {
      if (event.key === "Tab") {
        event.preventDefault();
        const textarea = this;
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        // Insert a tab character at the current caret position
        textarea.value = textarea.value.substring(0, start) + "\t" + textarea.value.substring(end);
        // Move the caret after the inserted tab
        textarea.selectionStart = textarea.selectionEnd = start + 1;
      }
    });

    // 5. Global keyboard shortcuts
    document.addEventListener("keydown", function(event) {
      const isMainText = (event.target.id === "inputText");
      const optionalControls = document.getElementById("optionalControls");
      const isOptional = optionalControls && optionalControls.contains(event.target);

      if (isMainText || isOptional) {
        if (event.ctrlKey && event.key === "Enter") {
          event.preventDefault();
          processText();
        }
        if (event.ctrlKey && event.shiftKey && event.key.toLowerCase() === "c") {
          event.preventDefault();
          copyToClipboard();
        }
      }
    });

    // 6. Process the text (pass optional controls to transformation)
    function processText() {
      const input = document.getElementById("inputText").value;
      let opts = {};

      if (Array.isArray(toolConfig.optionalControls)) {
        toolConfig.optionalControls.forEach(control => {
          const controlId = `control-${control.property}`;
          if (control.type === "radio") {
            const selected = document.querySelector(`input[name="${controlId}"]:checked`);
            if (selected) opts[control.property] = selected.value;
          } 
          else if (control.type === "text") {
            const element = document.getElementById(controlId);
            if (element) {
              opts[control.property] = element.value;
            }
          }
        });
      }

      const output = toolConfig.transformation(input, opts);
      document.getElementById("outputText").value = output;
    }

    // 7. Copy to clipboard
    function copyToClipboard() {
      const outputText = document.getElementById("outputText");
      outputText.select();
      outputText.setSelectionRange(0, 99999); // For mobile devices.
      navigator.clipboard.writeText(outputText.value);
      document.getElementById("inputText").focus();
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
